\chapter{Popis metody}

%------------------------------------------------------------------------------------------------------------------------------------------%

V této kapitole bude zevrubnì popsána implementovaná metoda. 

Metoda má nìkolik èástí

\begin{enumerate}
	\item Pøíprava snímku,
	\item slícování snímku s pøedchozími,
	\item zaèlenìní snímku do modelu.
\end{enumerate}

Pøíprava snímku zahrnuje aplikaci filtrù na vstupní data hloubkové mapy za úèelem vyhlazení a odstranìní ¹umu. Hloubková mapa je následnì pøevedena na mno¾inu souøadnic 
bodù v prostoru (bodové mraèno).

Pøipravené bodové mraèno je poté tøeba slícovat s body z pøedcházejících snímkù. 

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Filtrování obrazových dat}

Nasnímaná data nejprve zpracujeme pomocí filtru, ukázalo se ¾e tento krok výraznì zlep¹uje rychlost konvergence a kvalitu výstupù dal¹ích krokù algoritmu. Na hloubkový sken v pravidelném rastru se mù¾eme dívat jako na obrázek o jednom barevném kanálu, co¾ nám umo¾òuje pou¾ít grafické filtry bì¾nì pou¾ívané pro zpracování obrazu. Na¹ím hlavním cílem je redukce ¹umu. K tomu se èasto pou¾ívá Gaussovo rozostøení. Nedostatkem tohoto filtru je v¹ak to, ¾e dochází ke ztrátì informace o hranách v obraze. Tento nedostatek øe¹í bilaterální filtr, který zachovává ostré hrany, ale odstraòuje ¹um.

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.8\textwidth]{img/edge}
  \caption{Porovnání masky Gaussovského rozostøení a Bilaterálního filtru a jejich vlivu na hranu}
  \label{fig:edge}
\end{figure}

\begin{figure}[!htb]
     \begin{center}
        \subfigure[Pùvodní obrázek]{
            \label{fig:first}
            \includegraphics[width=0.3\textwidth]{img/01-orig.png}
        }
        \subfigure[Gaussovo rozostøení]{
           \label{fig:second}
           \includegraphics[width=0.3\textwidth]{img/01-gauss.png}
        }
        \subfigure[Bilaterální filtr]{
            \label{fig:third}
            \includegraphics[width=0.3\textwidth]{img/01-bilateral.png}
        }
    \end{center}
    \caption{%
        Porovnání Gaussova rozostøení a bilaterálního filtru
     }
   \label{fig:subfigures}
\end{figure}

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Pøevod hloubkové mapy na body v prostoru}

\begin{figure}[!htb]
  \centering
  \includegraphics[width=\textwidth]{img/kinect_geometry.pdf}
  \caption{Geometrický model Kinectu}
  \label{fig:kinect_geometry}
\end{figure}

Data dodaná senzorem Kinect ve formì pole hloubek je pro dal¹í zpracování nutné pøevést na souøadnice prostorových bodù. K provedení výpoètu je senzor nahrazen zjednodu¹eným modelem dírkové komory. Pøedpokládá se, ¾e ka¾dý reálný bod $\mathbf{p}$ o souøadnicích $(x, y, z)$ je promítán na obrazovou rovinu le¾ící ve vzdálenosti $f$ od dírky. Prùmìtem je bod $\mathbf{p}'$ o souøadnicích $(u, v, d)$.  Mezi souøadnicemi reálného bodu $\mathbf{p}$ a jeho obrazu na obrazové rovinì $\mathbf{p}$ platí následující vztahy

\begin{equation}
\begin{split}
\mathbf{p}(x) = \frac{\mathbf{p}'(d) \cdot (\mathbf{p}'(u) - c_x)}{f_x}		\\ 
\mathbf{p}(y) = -\frac{\mathbf{p}'(d) \cdot (\mathbf{p}'(v) - c_y)}{f_x}	\\ 
\mathbf{p}(z) = \mathbf{p}'(d)
\end{split}
\end{equation}

kde $(c_x, c_y)$ jsou souøadnice osy ohniska infraèervené kamery Kinectu na snímku - tedy støed snímku. Souøadnice bodu $\mathbf{p}'$ - $u$ a $v$ pøedstavují pozici pixelech na hloubkové mapì. Hodnota $d$ reprezentuje hloubku, tedy reálnou vzdálenost mezi senzorem a bodem. Souøadnice bodu $\mathbf{p}$ v milimetrech se vztahují k lokálnímu souøadnému systému jeho¾ poèátek pøedstavuje právì dírka modelové dírkové komory.

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Vytvoøení normálové mapy}

K dal¹ímu zpracování je krom souøadnic jednotlivých bodù ve snímku tøeba znát i hodnoty normálových vektorù ploch snímané scény v tìchto bodech. Pro zjednodu¹ení výpoètu urèíme jako normálu plochy scény v daném bodì jako normalizovaný normálový vektor roviny urèené tímto bodem a sousedními body v horizontálním a vertikálním smìru.

\begin{equation}
\begin{split}
\mathbf{u} = \mathbf{p}_{i + 1, j} - \mathbf{p}_{i, j}  \\
\mathbf{v} = \mathbf{p}_{i, j + 1} - \mathbf{p}_{i, j}  \\
\mathbf{n} = \frac{\mathbf{u} \times \mathbf{v}}{|\mathbf{u} \times \mathbf{v}|}
\end{split}
\end{equation}


\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.7\textwidth]{img/normals.png}
  \caption{Normály scény znázornìné pomocí virtuálních barev}
  \label{fig:kinect_normals}
\end{figure}

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Spojování snímkù}
% p = b, q = t

Souøadnice bodù nového snímku se vtahují k lokálnímu souøadnému systému s poèátkem v poloze senzoru pøi poøízení snímku. Pro sestavení celkového modelu scény je v¹ak tøeba v¹echny snímky pøevést do jednotného globálního souøadného systému. Pro jednoduchost jej ztoto¾níme se souøadným systémem prvního zpracovávaného snímku.

Vztah mezi souøadnými systémy nového snímku $P$ a pøedchozího snímku snímku $Q$ lze vyjádøit pomocí rigidní transformace $[\mathbf{R}, \mathbf{t}]$, která se skládá z matice rotace $\mathbf{R}$ a vektoru translace $\mathbf{t}$.

Pro nalezení takovéto transformace byl pou¾it algoritmus ICP (Iterative closest point - \textit{iterace pøes nejbli¾¾¹í bod}). Jedná se o iteraèní algoritmus èasto pou¾ívaný v 3D grafice pro spojování prostorových objektù. V práci byla pou¾ita varianta algoritmu známá jako "bod - rovina" ("Point-to-plane").

% cite: http://www.comp.nus.edu.sg/~lowkl/publications/lowk_point-to-plane_icp_techrep.pdf

Prvním krokem v algoritmu ICP je nalezení shodných bodù mezi snímky $P$ a $Q$. Je známo nìkolik efektivních strategií pro hledání takovýchto shod. Nejjednodu¹¹í mo¾ností je pro ka¾dý bod z mno¾iny snímku $P$ projít v¹echny body snímku $Q$ a vybrat nejbli¾¹í. Metody tohoto typu jsou vhodné pøi zpracování snímkù mezi kterými je velká transformace a dávají velmi dobré výsledky. Jejich nevýhodou je v¹ak znaèná èasová slo¾itost (pøi naivní implementaci $O(N^2)$, pøi pou¾ití stromových datových struktur $O(n \cdot log n)$). %http://en.wikipedia.org/wiki/K-d_tree%

Je-li v¹ak mezi obìma snímky transformace malá, lze s výhodou vyu¾ít pøedpokladu, ¾e hledaný nejbli¾¹í bod se na snímku $Q$ nachází na podobných souøadnicích $[u, v]$ jako na snímku $P$. Metoda zalo¾ená na tomto principu a pou¾ita v práci je oznaèována jako projektivní asociace (\textit{Projective data association}). 

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.5\textwidth]{img/projective_data_association.pdf}
  \caption{Princip projektivní asociace}
  \label{fig:pda}
\end{figure}

Po nalezení párù bodù mù¾eme urèit chybu mezi tìmito snímky. Nejjednodu¹¹í zpùsob pøedstavuje pou¾ití Eukleidovské vzdálenosti mezi spárovanými body - tedy metrika bod - bod. Nicménì efektivnìj¹í mo¾ností je pou¾ít metriku bod - rovina. Pøi ní vzdálenost mezi body v páru nahradíme vzdáleností $l$ mezi $p$ a rovinou bodu $p$ a jeho normály $n$.

%http://www.comp.nus.edu.sg/~lowkl/publications/lowk_point-to-plane_icp_techrep.pdf

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.5\textwidth]{img/point_to_plane.pdf}
  \caption{Metrika bod - rovina}
  \label{fig:point2plane}
\end{figure}

Chybu zarovnání mù¾eme definovat 

\begin{equation}
e = \sum_{i}[(\mathbf(R) \cdot \mathbf{p}_i + \mathbf{t} - \mathbf{q}_i) \cdot \mathbf{n}_i]^2
\end{equation}

Snímky pova¾ujeme za zarovnané, je-li $e <= \epsilon$, kde $\epsilon$ je zvolená tolerance. Nalezení vhodné transformace $[\mathbf{R}, \mathbf{t}]$ je ve své podstatì optimalizaèní problém metody nejmen¹ích ètvercù.

Matice rotace $\mathbf{R}$ je tvoøena kosiny a siny Eulerových úhlù, jedná se tedy o nelineární funkci. Pøedpokládáme-li v¹ak, ¾e rotace mezi snímky je malá, mù¾eme ji aproximovat linearizovaným tvarem

\begin{equation}
\mathbf{R} \approx 
\left(
\begin{array}{ccc@{\ }r}
	1 		& -\gamma 	& \beta	 	\\
    \gamma 	& 1 		& -\alpha 	\\
    -\beta	& \alpha	& 1
\end{array}
\right)
\end{equation}

Vektor translace má obecný tvar

\begin{equation}
\mathbf{t} = 
\begin{array}{ccc@{\ }r}
	t_x	 	&
    t_y 	&
    t_z
\end{array}^T
\end{equation}

jeho slo¾ky pøedstavují posunutí ve smìru os souøadného systému. 

Definujeme-li 
\begin{equation}
\mathbf{c}_i = \mathbf{p}_i  \mathbf{n}_i
\end{equation}

Mù¾eme chybu zarovnání zapsat jako

\begin{equation}
e = \sum_{i}[(\mathbf{p}_i - \mathbf{q}_i) \cdot \mathbf{n}_i + \mathbf{t} \cdot \mathbf{n}_i + \mathbf{R} \cdot \mathbf{c}_i]^2
\end{equation}

Hledanými parametry jsou úhly $\alpha$, $\beta$, $\gamma$ a posunutí $t_x$, $t_y$, $t_z$. Úlohu lze øe¹it pomocí metody nejmen¹ích ètvercù, která vede na øe¹ení lineární soustavy 

\begin{equation}
\sum_{i}
\left(
\begin{array}{cccccc@{\ }r}
	c_{i,x} c_{i,x}		& 	c_{i,x} c_{i,y}		&	c_{i,x} c_{i,z}		&	c_{i,x} n_{i,x}		&	c_{i,x} n_{i,y}		&	c_{i,x} n_{i,z}	\\
    c_{i,y} c_{i,x} 	& 	c_{i,y} c_{i,y}		&	c_{i,y} c_{i,z}		&	c_{i,y} n_{i,x}		&	c_{i,y} n_{i,y}		&	c_{i,y} n_{i,z}	\\
    c_{i,z} c_{i,x}		& 	c_{i,z} c_{i,y}		&	c_{i,z} c_{i,z}		&	c_{i,z} n_{i,x}		&	c_{i,z} n_{i,y}		&	c_{i,z} n_{i,z} \\
    n_{i,x} c_{i,x}		&	n_{i,x} c_{i,y}		&	n_{i,x} c_{i,z}		&	n_{i,x} n_{i,x}		&	n_{i,x} n_{i,y}		&	n_{i,x} n_{i,z} \\
    n_{i,y} c_{i,x}		&	n_{i,y} c_{i,y}		&	n_{i,y} c_{i,z}		&	n_{i,y} n_{i,x}		&	n_{i,y} n_{i,y}		&	n_{i,y} n_{i,z} \\
    n_{i,z} c_{i,x}		&	n_{i,z} c_{i,y}		&	n_{i,z} c_{i,z}		&	n_{i,z} n_{i,x}		&	n_{i,z} n_{i,y}		&	n_{i,z} n_{i,z}
\end{array}
\right)
\left(
\begin{array}{c@{\ }r}
	\alpha 	\\
    \beta   \\
    \gamma  \\
    t_x		\\
    t_y		\\
    t_z	
\end{array}
\right) =  - \sum_{i}
\left(
\begin{array}{c@{\ }r}
	c_i,x (p_i - q_i) \cdot n_i 	\\
    c_i,y (p_i - q_i) \cdot n_i 	\\
    c_i,z (p_i - q_i) \cdot n_i 	\\
    n_i,x (p_i - q_i) \cdot n_i 	\\
    n_i,y (p_i - q_i) \cdot n_i 	\\
    n_i,z (p_i - q_i) \cdot n_i 	
\end{array}
\right)
\end{equation}


Vzhledem k tomu, ¾e matice je symetrické, mù¾eme k øe¹ení efektivnì vyu¾ít LU nebo QR rozklad. Získaný vektor $\mathbf{x}$ je tvoøen Eulerovými úhly a slo¾kami translaèního vektoru.

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Objemová reprezentace dat}
 
Známe-li transformaci nového snímku vùèi globálního systému, mù¾eme jej zaèlenit do celkového modelu scény. Ten je reprezentován formou objemových dat. Model si mù¾eme pøedstavit jako krychli obsahující èást snímaného prostoru. Celá krychle je pravidelnì rozdìlena na malé krychlové podoblasti - voxely. Vzhledem k velké datové nároènosti takovéhoto zpùsobu reprezentace modelu je oblast, která do nìj lze zachytit silnì omezena. V práci byla pou¾ita krychle o rozmìrech $3 m \times 3 m \times 3m$, která byla rozdìlena na $512 \times 512 \times 512$ voxelù. 
Ka¾dý voxel obsahuje dvì hodnoty. Hodnotu vzdálenostní funkce a její váhu. Oøíznutá znaménková funkce vzdálenosti (truncated signed distance function) reprezentuje vzdálenost mezi støedem buòky a povrchem pøedmìtu. 

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.7\textwidth]{img/tsdf.pdf}
  \caption{Prùbìh TSDF}
  \label{fig:tsdf}
\end{figure}

Hodnota 0 znamená, ¾e hrana prochází pøímo støedem. Hodnota $-1$ reprezentuje buòky uvnitø pøedmìtu, kterými ¾ádná hrana neprochází. Hodnota $+1$ analogicky oznaèuje buòky vnì pøedmìtu bez hrany. Hodnoty $(0, 1)$

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.7\textwidth]{img/sdf.pdf}
  \caption{2D køivka popsána pomocí skalárního pole hodnot TSDF}
  \label{fig:sdf}
\end{figure}

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Získání hloubkového snímku z objemových dat}

V podkapitole ~\ref{sec:Spojování snímkù} byl uveden postup pro výpoèet transformace nového snímku vùèi pøedchozímu snímku. Pokud bychom pou¾ili pøedchozí snímek z Kinectu, do¹lo by pomìrnì brzy k akumulaci drobných chyb v zarovnání. Tento relativní zpùsob zarovnávání je tedy reálnì nepou¾itelný. 

První mo¾ností, jak relativní zpùsob nahradit je pou¾ít absolutní zarovnávání vùèi úplnì prvnímu pøijatému pro v¹echny nové snímky. To by v¹ak bylo pou¾itelné pouze pro nìkolik málo snímkù málo transformovaných oproti prvnímu snímku. 

Jako nejrozumnìj¹í mo¾nost se jeví pou¾ít relativní zpùsob zarovnávání, ale místo reálnì pøijatého pøedchozího snímku vytvoøit virtuální snímek z objemového modelu pro pøedchozí model kamery. Pro tento úkol je mimoøádnì vhodná metoda trasování paprsku (ray casting).



%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Generování trojúhelníkové sítì}
%http://www.cs.virginia.edu/johntran/GLunch/marchingcubes.pdf%
Pro vykreslení modelu jsou objemová data pøevedena na polygonovou sí» reprezentující povrch. K vytvoøení polygonové trojúhelníkové sítì je znám pomìrnì efektivní a jednoduchý algoritmus "pochodující kostky" (marching cubes). Kostky neboli buòky jsou tvoøeny z 8 sousedících voxelù objemové møí¾ky. Její rohy jsou vertexy vypoètené jako støed voxelu.

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.7\textwidth]{img/voxel-cell.pdf}
  \caption{Vztah mezi buòkou a voxely}
  \label{fig:marching_cubes_triangles}
\end{figure}

Poèet bunìk, nacházejících se na rozhraní mezi modelem tìlesa a okolím je ve srovnání s celkovým poètem objemových bunìk relativnì malý. Je tedy výhodné algoritmus aplikovat pouze na takovéto buòky. K tomu byla pou¾ita jednoduchý metoda, která projde v¹echny buòky a na výstup zapí¹e indexy tìch, kde je hodnota $TSDF \in (-1 ; 1)$. Seznam indexù bunìk na rozhraní slou¾í jako jeden z parametrù algoritmu marching cubes.

Algoritmus urèí, jakým zpùsobem plocha prochází buòkou a poté pøejde ("pochoduje") k dal¹í kostce. K urèení øezu, který plocha v buòce vytváøí, nejprve urèíme, které rohy buòky le¾í pøed a které za plochou. Vertexy pøed plochou oznaèíme bitovou 1, vertexy za plochou oznaèíme 0. Z bitù pro jednotlivé vertexy sestavíme 8-bitové èíslo - index buòky. Proto¾e je buòka tvoøena 8 vrcholy, existuje $2^8 = 256$ mo¾ných topologických variant øezu. Jednotlivé varianty jsou pøedem známy a ulo¾eny ve statické tabulce trojúhelníkù. Pro pøístup k topologii øezu v tabulce trojúhelníkù slou¾í právì 8-bitový index buòky.

Topologie øezu popisuje definuje hrany, které obsahují vrchol nìkterého trojúhelníku. K výpoètu reálných souøadnic vrcholù trojúhelníku je pou¾ita lineární interpolace za pomoci hodnot TSDF v jednotlivých rozích. 

\begin{minipage}{\textwidth}
\begin{lstlisting}[label=triangle_map,caption={Èást tabulky trojúhelníkù}]
__constant int triangle_map[4096] = 
{
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,		
//  trojúhelník neprotíná ¾ádnou hranu
	0, 8, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,		
//  trojúhelník protíná hrany èíslo 0, 8 a 3
	0, 1, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,	
//  trojúhelník protíná hrany èíslo 0, 1, a 9
	1, 8, 3, 9, 8, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,			
//  první trojúhelník protíná hrany èíslo 1, 8, a 3, druhý hrany 9, 8, a 1
	...
\end{lstlisting}
\end{minipage}	
	

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.7\textwidth]{img/marching-cubes.jpg}
  \caption{Konfigurace povrchových polygonù v buòce dle vertexù le¾ících mimo tìleso}
  \label{fig:marching_cubes_triangles}
\end{figure}

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.7\textwidth]{img/cube.pdf}
  \caption{Èíslování hran a vrcholù buòky}
  \label{fig:marching_cubes_case}
\end{figure}

\begin{figure}[!htb]
  \centering
  \includegraphics[width=0.7\textwidth]{img/marching_cubes.pdf}
  \caption{Buòka protnutá plochou, její index a pøíslu¹ná topologie}
  \label{fig:marching_cubes_case}
\end{figure}

