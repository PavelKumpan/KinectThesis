\chapter{Popis metody}

%------------------------------------------------------------------------------------------------------------------------------------------%

V této kapitole bude zevrubnì popsána implementovaná metoda. 

\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.8\textwidth]{img/edge}
  \caption{}
  \label{fig:edge}
\end{figure}

\section{Stereo triangulace}

\section{Filtrování obrazových dat}

Nasnímaná data nejprve zpracujeme pomocí filtru, ukázalo se ¾e tento krok výraznì zlep¹uje rychlost konvergence a kvalitu výstupù dal¹ích krokù algoritmu. Na hloubkový sken v pravidelném rastru se mù¾eme dívat jako na obrázek o jednom barevném kanálu, co¾ nám umo¾òuje pou¾ít grafické filtry bì¾nì pou¾ívané pro zpracování obrazu. Na¹ím hlavním cílem je redukce ¹umu. K tomu se èasto pou¾ívá Gaussovo rozostøení. Nedostatkem tohoto filtru je v¹ak to, ¾e dochází ke ztrátì informace o hranách v obraze. Tento nedostatek øe¹í bilaterální filtr, který zachovává ostré hrany, ale odstraòuje ¹um.


%\begin{figure}[htbp]
%  \centering
%  \includegraphics[width=0.8\textwidth]{img/edge}
%  \caption{Porovnání masky Gaussovského rozostøení a Bilaterálního filtru a jejich vlivu na hranu}
%  \label{fig:edge}
%\end{figure}

\begin{figure}[htpb]
     \begin{center}
        \subfigure[Pùvodní obrázek]{
            \label{fig:first}
            \includegraphics[width=0.3\textwidth]{img/01-orig.png}
        }
        \subfigure[Gaussovo rozostøení]{
           \label{fig:second}
           \includegraphics[width=0.3\textwidth]{img/01-gauss.png}
        }
        \subfigure[Bilaterální filtr]{
            \label{fig:third}
            \includegraphics[width=0.3\textwidth]{img/01-bilateral.png}
        }
    \end{center}
    \caption{%
        Porovnání Gaussova rozostøení a bilaterálního filtru
     }
   \label{fig:subfigures}
\end{figure}

Bilaterální filtr má jako¾to nelineární filtr v základní implementaci vysokou èasovou nároènost ${O(m * N^{k})}$ ($m$ je poèet pixelù v obraze, $N$ je polomìr jádra filtru, $k$ je poèet rozmìrù obrazu), co¾ je pro úèely filtrace v reálném èase zcela nedostateèné. Proto jsme pou¾ili pøístup, který vyu¾ívá vzorkování filtrované oblasti a èasovou nároènost zlep¹uje na ${O(m * N * k)}$. Pro vzorkování je pou¾ita metoda Poisson Disc. Vzorky získané touto metodou mají rovnomìrnìj¹í rozdìlení ne¾ vzorky vygenerované pomocí pseudonáhodných èísel a oproti vzorkùm s pravidelným møí¾kovým rozlo¾ením nevytváøejí v obrazu fragmenty.

\begin{figure}[tbp]
     \begin{center}
        \subfigure[Møí¾ka]{
            \label{fig:first}
            \fbox{\includegraphics[width=0.28\textwidth]{img/02-grid.png}}
        }
        \subfigure[Náhodný výbìr]{
           \label{fig:second}
           \fbox{\includegraphics[width=0.28\textwidth]{img/02-random.png}}
        }
        \subfigure[Poisson Disk]{
            \label{fig:third}
            \fbox{\includegraphics[width=0.28\textwidth]{img/02-poissonDisk.png}}
        }
    \end{center}
    \caption{%
        Porovnání vzorku vytvoøeného algoritmem Poisson Disc se vzorkem pravidelné møí¾ky a náhodného výbìru
     }
   \label{fig:subsampling}
\end{figure}

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Pøevod hloubkové mapy na body v prostoru}

\begin{figure}[htbp]
  \centering
  \includegraphics[width=\textwidth]{img/kinect_geometry.pdf}
  \caption{Geometrický model Kinectu}
  \label{fig:kinect_geometry}
\end{figure}

Pro pøevod dat z hloubkové mapy je hloubkový senzor Kinectu nahrazen zjednodu¹eným modelem dírkové komory - viz obrázek ~\ref{fig:kinect_geometry}. Pøedpokládá se, ¾e ka¾dý reálný bod $P$ o souøadnicích $(x, y, z)$ je promítán na obrazovou rovinu le¾ící ve vzdálenosti $f$ od dírky jako bod $P'$ o souøadnicích $(u, v, d)$. Mezi souøadnicemi reálného bodu $P$ a jeho obrazu na obrazové rovinì $P$ platí následující vztahy

\begin{equation}
P(x) = \frac{P'(d) \cdot (P'(u) - c_x)}{f}
\end{equation}
\begin{equation}
P(y) = -\frac{P'(d) \cdot (P'(v) - c_y)}{f}
\end{equation}
\begin{equation}
P(z) = P'(d)
\end{equation}

kde $(c_x, c_y)$ jsou souøadnice osy ohniska infraèervené kamery Kinectu na snímku - tedy støed snímku. Souøadnice bodu $P'$  $u$ a $v$ jsou souøadnicemi na hloubkové mapì v pixelech. Souøadnice $d$ je hodnota pole hloubkové mapy která odpovídá reálné vzdálenosti v milimetrech. Souøadnice bodu $P$ jsou v milimetrech a vztahují se k lokálnímu souøadnému systému jeho¾ poèátek pøedstavuje právì dírka modelové dírkové komory.


%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Spojování skenù}

Pro sestavení scény byl pou¾it algoritmus ICP (iterative closest point - iterace pøes nejbli¾¹í bod). Jedná se o iteraèní algoritmus pro spojování bodových mraèen. 

% p = b, q = t

Vstupní data pøedstavují dvì mno¾iny souøadnic bodù ${p_i}$ a ${q_i}$, $i\in1,...,n$ ve trojrozmìrném prostoru. Mno¾ina bodù  $\mathbf{P}$ pøedstavuje základní snímek, mno¾ina $\mathbf{Q}$ nový snímek, který chceme zarovnat ke snímku $\mathbf{P}$.

Problém pøedstavuje zarovnání nového snímku Q k pøedchozímu snímku P. P a Q obsahují souøadnice bodù vzhledem k aktuální poloze senzoru. Snímky v¹ak byly poøízeny v rùzných polohách senzoru. Chceme tedy body nového snímku posunout lokálního souøadného systému senzoru do globálního souøadného systému modelované scény, který pro nás pøedstavuje souøadný systém snímku P.

\subsection{Výbìr bodù pro zarovnání} 

Pro výbìr bodù se kterými ICP pracuje lze zvolit nìkolik strategií  

\begin{itemize}
	\item 
	\textsc{Pou¾ití v¹ech bodù} je èasovì nejnároènìj¹í, ale dává velmi dobré výsledky a je odolné proti ¹umu.
	\item
	\textsc{Pou¾ití podmno¾iny bodù} s pravidelným nebo náhodným vzorkováním.
	\item
	\textsc{Výbìr zajímavých bodù} na základì obrazové informace. Mù¾e se jednat o body s vysokou intenzitou gradientu hloubky nebo jasové slo¾ky barevné informace (je-li dostupná).
	\item
\end{itemize}

V systému bylo pou¾ito náhodné vzorkování metodou Poisson Disk (viz \ref{fig:subsampling})

\subsection{Získání párù bodù} 

Algoritmus ICP, jak u¾ název napovídá, pracuje nad páry nejbli¾¹ích bodù v jednotlivých snímcích. Tedy ke ka¾dému bodu $q_i$ z mno¾iny $\mathbf{Q}$ nového snímku musíme získat nejprve nejbli¾¹í bod $p_i$ z mno¾iny základního snímku $\mathbf{P}$. V ideálním pøípadì se jedná v reálném prostøedí o toto¾né body.

\begin{itemize}
	\item 
	\textsc{Hledání v celém mno¾inì} je nejjednodu¹¹ím pøístupem. K nalezení bodu $p_i$ musíme prohledat celou mno¾inu $P$. Rychlej¹í 		variantou je nejprve body rozdìlit do stromové struktury, napøíklad K-d stromu nebo oktalového stromu a problém se redukuje na prohledávání stromu s výraznì ni¾¹í èasovou nároèností. Výhodou toho pøístupu jsou velmi kvalitní výsledky, mo¾nost zarovnávat i snímky mezi nimi¾ je velká transformace. Nicménì pro real-time pou¾ití je tento pøístup zcela nepou¾itelný a své místo nachází pøedev¹ím v aplikacích kde je výpoèetní èas ménì dùle¾itý v porovnání s pøesností.
	\item
	\textsc{Metody zalo¾ené na významných bodech} jako Lucas-Kanade pracují s 
	\item
	\textsc{Projektivní asociace} vychází z pøedpokladu ¾e mezi snímky je velmi malá transformace a bod se na jednom snímku nachází na velmi podobných souøadnicích jako na druhém. 
	\textsc{Prohledávání okolí projekce} je roz¹íøením projektivní asociace. Místo toho abychom za nejbli¾¹í bod prohlásili pøímo bod na souøadnicích $[u, v]$, prohledáme oblast v jeho okolí a nalezneme nejbli¾¹í bod.
\end{itemize}

\begin{figure}[htpb]
     \begin{center}
        \subfigure[Projektivní asociace]{
            \label{fig:first}
            \includegraphics[width=0.45\textwidth]{img/projective_data_association.pdf}
        }
        \subfigure[Prohledávání okolí projekce]{
           \label{fig:second}
           \includegraphics[width=0.45\textwidth]{img/projective_data_search.pdf}
        }
    \end{center}
    \caption{%
        Princip projektivní asociace a prohledávání okolí projekce
     }
   \label{fig:associations}
\end{figure}

\subsection{Popis algoritmu ICP}

Relaci mno¾in $\mathbf{P}$ a $\mathbf{Q}$ mù¾eme vyjádøit jako

\begin{equation}
p_i = \mathbf{R} q_i + \mathbf{t} + \mathbf{V}_i
\end{equation}

kde $\mathbf{R}$ je ètvercová matice rotace, $\mathbf{T}$ je vektor translace a $\mathbf{V}$ pøedstavuje vektor ¹umu. Na¹ím cílem je nalézt takovou transformaci vyjádøenou pomocí $[\mathbf{\hat{R}}, \mathbf{\hat{t}}]$, která minimalizuje kriteriální funkci 

\begin{equation}
e = \sqrt{\sum\limits_{i=1}^n \Vert p_i - \mathbf{\hat{R}} q_i - \mathbf{\hat{t}} \Vert^{2}}
\end{equation}


Nejprve urèíme tì¾i¹tì $\bar{p}$, $\bar{q}$ mno¾in $\mathbf{P}$ a $\mathbf{Q}$.

\begin{equation}
\bar{p} = \frac{1}{n} \sum\limits_{i=1}^n p_i \\*
\bar{q} = \frac{1}{n} \sum\limits_{i=1}^n q_i
\end{equation}

Urèíme vektory mezi jednotlivými body mno¾in a jejich tì¾i¹ti.


\begin{equation}
p_ci = p_i - \bar{b}
\end{equation}

\begin{equation}
q_ci = q_i - \bar{t}
\end{equation}

Následnì vypoèteme korelaèní matici $\mathbf{H}$ z tìchto vektorù.


\begin{equation}
\mathbf{H} = \sum\limits_{i=1}^n q_{ci} p_{ci}^T
\end{equation}

Pomocí singulárního rozkladu mù¾eme matici $\mathbf{H}$ rozlo¾it na vektory $\mathbf{U}$ a $\mathbf{V}$.


\begin{equation}
\mathbf{H} = \mathbf{U}\mathbf{\Sigma}\mathbf{V}^T
\end{equation}

Ze kterých pak vypoèteme matici rotace. 


\begin{equation}
\mathbf{\hat{R}} = \mathbf{V} \mathbf{U}^T
\end{equation}

Pokud je $\det{(\mathbf{\hat{R}})} = -1$ pak do¹lo k selhání výpoètu. To mù¾e nastat, je-li v obraze pøíli¹ mnoho ¹umu, nebo jsou-li mno¾in bodù rovinné. V tomto pøípadì lze rotaci urèit 

\begin{equation}
\mathbf{\hat{R}} = \mathbf{U}
\left(
\begin{array}{ccc@{\ }r}
	1 & 0 & 0 \\
    0 & 1 & 0 \\
    0 & 0 & \det{(\mathbf{U} \mathbf{V}^T)}
\end{array}
\right)
\mathbf{V}^T
\end{equation}

Nejvhodnìj¹í translace je pak taková, která tì¾i¹tì mno¾iny $\mathbf{Q}$ posune do tì¾i¹tì mno¾iny $\mathbf{P}$.

\begin{equation}
\mathbf{\hat{t}} = \bar{p} - \mathbf{\hat{R}} \bar{q}
\end{equation}

Získanou transformaci mù¾eme aplikovat na jednotlivé prvky mno¾iny $\mathbf{Q}$

\begin{equation}
q_i = \mathbf{R} p_i + \mathbf{t}
\end{equation}

Vypoèteme hodnotu kriteriální funkce a je-li dostateènì malá algoritmus ukonèíme. Není-li tomu tak, opakujeme algoritmus do té body ne¾ jsou snímky dostateènì zarovnané nebo nedosáhneme maximálního poètu iterací. 

%------------------------------------------------------------------------------------------------------------------------------------------%

\section{Reprezentace bodového mraèna v programové pamìti}

Pro uchování zarovnaných snímkù byla pou¾ita datová struktura \emph{oktalový strom} (té¾ \emph{oktantový strom}, \emph{octree}). Jedná se o stromovou strukturu pou¾ívanou v poèítaèové grafice pro ukládání a reprezentaci trojrozmìrných scén. Oktalový strom je o analogickým roz¹íøením 1-rozmìrných binárních stromù. 

\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.5\textwidth]{img/octree_struc.png}
  \caption{Struktura oktalového stromu ve dvourozmìrné podobì}
  \label{fig:octree}
\end{figure}

Struktura se skládá z koøene, který si mù¾eme pøedstavit jako krychli zahrnující urèitý prostor. Koøen má 8 potomkù - bunìk (\emph{oktantù}, \emph{octants}), které koøenovou krychli dìlí na 8 men¹ích krychlí. Ka¾dý z oktantù mù¾e mít svých 8 potomkù, nebo mù¾e být koncovým uzlem, neboli listem (\emph{leaf}). V listu jsou pak ulo¾eny souøadnice v¹ech vertexù, které se v dané oblasti prostoru vymezené krychlí uzlu nacházejí. 

\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.5\textwidth]{img/octree_rabit.jpg}
  \caption{Model králíka zachycený ve struktuøe oktalového stromu}
  \label{fig:octree}
\end{figure}
